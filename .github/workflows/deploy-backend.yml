name: Backend Docker Deploy

on:
  workflow_dispatch:

env:
  IMAGE_NAME: backend
  DOCKERFILE_PATH: ./vrse-builder-backend-main/Dockerfile
  CONTEXT_PATH: ./vrse-builder-backend-main

jobs:
  docker-build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------- Create Repo If Not Exists -----------------
      - name: Create Docker Hub Repo If Missing
        run: |
          echo "ðŸ” Checking if Docker Hub repo exists..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -u "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_PASSWORD }}" \
            https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME/)

          if [ "$RESPONSE" -eq 404 ]; then
            echo "ðŸš€ Repository doesn't exist. Creating..."
            curl -s -X POST https://hub.docker.com/v2/repositories/ \
              -u "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_PASSWORD }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "'$IMAGE_NAME'",
                "namespace": "'${{ secrets.DOCKERHUB_USERNAME }}'",
                "description": "Backend service",
                "is_private": false
              }'
            echo "âœ… Repo created successfully!"
          else
            echo "âœ… Repo already exists."
          fi

      # ----------------- Docker Hub Login -----------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Verify Docker Login
        run: docker info | grep Username

      # ----------------- Detect Dockerfile -----------------
      - name: Detect Dockerfile Path
        run: |
          if [ -f "$DOCKERFILE_PATH" ]; then
            echo "âœ… Detected Dockerfile at $DOCKERFILE_PATH"
          else
            echo "âŒ Dockerfile not found at $DOCKERFILE_PATH"
            exit 1
          fi

      # ----------------- Build and Push -----------------
      - name: Build and Push Docker Image
        run: |
          echo "ðŸ”¨ Building Docker image..."
          docker build -f $DOCKERFILE_PATH -t ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${{ github.sha }} $CONTEXT_PATH
          
          echo "ðŸ“¤ Pushing image to Docker Hub..."
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${{ github.sha }}

      # ----------------- Summary -----------------
      - name: Deployment Summary
        run: |
          echo "## âœ… Docker Image Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME" >> $GITHUB_STEP_SUMMARY
